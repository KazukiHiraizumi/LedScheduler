# ドライバープロトコル
## パケット構造
<table>
<tr><th>キー<th>値<th>Description
<tr><td>action<td><td>このパケットが意図する動作を示します。actionキー値によって、eventsキー値の意味合いが規定されます。
<tr><td><td>upload<td>eventsキーの値はスケジュールです。スケジュールデータのフォーム詳細は後述
<tr><td><td>download<td>このパケットは現在実行中のスケジュールを送信することを要求します。eventsキー値は、存在したとしても無視されます。
<tr><td><td>dump<td>eventsキーの値は、各チャネルの出力値です。ドライバーがこのパケットを受信した場合、現在の出力値の通知要求と解釈します。さらにもしactionキー値が存在する場合は出力をその内容に応じて更します。<br>クライアントがこのパケットを受信した場合、現在の出力値の通知と解釈します。
<tr><td>events<td>[{...},{...}...]<td>eventsキーは、ObjectのArrayにて、各request/responseに必要な情報が記述されます。
</table>

## eventsキー値の詳細
### uploadパケット  
actionキー値が**upload**のパケットは、スケジュール設定の授受を行います。このパケットのeventsキー値は下表のとおりです。
<table>
<tr><th>キー<th>値<th>Description
<tr><td>column<td>0::7 :int<td>このオブジェクトのチャンネル
<tr><td>startTime<td>0.00::24.00 :float<td>起点時刻を0:00とした経過時間。
<tr><td>value<td>0::100 :int<td>デューティ値
</table>

#### 例1. 下記のパケットをドライバーへ送ると「8:30にCH1を80%に切替え」「19:45にCH5を20%に切替え」スケジュール設定が行われます。

~~~
{
  'action':'upload',
  'events':[
    {'column':1,'startTime':8.5,'value':80},
    {'column':5,'startTime':19.75,'value':20}
  ]
}
~~~
また同パケットを受信した場合は、現在スケジュール設定と解釈します。

### downloadパケット  
actionキー値が**download**のパケットは、スケジュールの送信要求を行います。通常このパケットは、クライアント⇒ドライバー、への一方向です。このパケットのeventsキーを持ちません(あったとしても無視します)。
#### 例1. 下記のパケットをドライバーへ送ると、ドライバーは現在実行中のスケジュールを通知します。

~~~
{
  'action':'download',
}
~~~
ドライバーから通知されるパケットの書式は、**upload**パケットに同じです。

### dumpパケット  
actionキー値が**dump**のパケットは、現在の出力値の授受を行います。ただしeventsキーがない場合は、出力値の送信要求と解釈されます。eventsキーがある場合は、その内容は下表のとおりです。

<table>
<tr><th>キー<th>値<th>Description
<tr><td>column<td>int:0::7<td>このオブジェクトのチャンネル
<tr><td>value<td>int:0::100<td>デューティ値
</table>

#### 例1. 下記のパケットをドライバーへ送ると、ドライバーは出力値を通知します。

~~~
{
  'action':'dump'
}
~~~
ドライバーから通知されるパケットは下記のようになります。
~~~
{
  'action':'dump',
  'events':[
    {'column':1,'value':80},
    {'column':5,'value':20}
  ]
}
~~~
この例では、「CH1に80%」「CH5に20%」が出力されていることを通知しています。

#### 例2. 下記のパケットをドライバーへ送ると、「CH1に80%」「CH5に20%」を即座に出力します。

~~~
{
  'action':'dump',
  'events':[
    {'column':1,'value':80},
    {'column':5,'value':20}
  ]
}
~~~
例1のドライバーからの通知パケットと全く同じですが、このパケットをドライバーへ送ると、強制出力更新と解釈されます。ドライバーは出力を更新し、また出力値の通知も行ないます。
